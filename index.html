<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>부릉라이더스 정산서 조회</title>
<link rel="icon" type="image/png" href="VRriders.png">
<style>
body { font-family: Arial, sans-serif; text-align:center; padding:20px; }
table { max-width:600px; width:100%; border-collapse:collapse; margin:20px auto; font-size:16px; }
th { background-color:#b2dba1; border:1px solid black; padding:10px; text-align:center; }
td { background-color:#ffffff; border:1px solid black; padding:10px; text-align:center; }
.footer, .footer td { background-color:#b2dba1 !important; font-weight:bold; }
input { width:95%; padding:8px; font-size:14px; }
button { background-color:#4CAF50; color:white; padding:10px 15px; border:none; cursor:pointer; font-size:16px; margin-top:10px; }
button:hover { background-color:#45a049; }
#result { margin-top:20px; }
</style>
</head>
<body>
<h2>부릉라이더스 정산서 조회</h2>
<p>코드 및 정산 문의 : 010-9785-1293</p>
<form id="searchForm">
<table>
<tr><td>입금 날짜</td><td><input type="text" id="searchDate" placeholder="예: 250307"></td></tr>
<tr><td>검색 코드</td><td><input type="text" id="searchCode" placeholder="예: C202401001"></td></tr>
</table>
<button type="submit">검색</button>
</form>

<h3>검색 결과</h3>
<div id="result"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function calculatePeriod(searchDate) {
    var year = parseInt("20" + searchDate.substring(0,2));
    var month = parseInt(searchDate.substring(2,4)) - 1;
    var day = parseInt(searchDate.substring(4,6));
    var inputDate = new Date(year, month, day);
    var dayOfWeek = inputDate.getDay();
    var wednesdayDate = new Date(inputDate);
    wednesdayDate.setDate(inputDate.getDate() - dayOfWeek - 4);
    var tuesdayDate = new Date(wednesdayDate);
    tuesdayDate.setDate(wednesdayDate.getDate() + 6);
    function formatDate(date) {
        var mm = String(date.getMonth()+1).padStart(2,'0');
        var dd = String(date.getDate()).padStart(2,'0');
        return mm + "/" + dd;
    }
    return formatDate(wednesdayDate) + " ~ " + formatDate(tuesdayDate);
}

$(document).ready(function(){
    $('#searchForm').submit(function(event){
        event.preventDefault();
        if ($(this).data("processing")) return;
        $(this).data("processing", true);

        var searchDate = $('#searchDate').val().trim();
        var searchCode = $('#searchCode').val().trim().toUpperCase();

        if (!/^\d{6}$/.test(searchDate)) {
            alert("입금 날짜는 6자리 숫자로 입력하세요.");
            $(this).data("processing", false);
            return;
        }
        if (!/^[C]\d{9}$/.test(searchCode)) {
            alert("검색 코드는 'C'로 시작하는 10자리 형식이어야 합니다.");
            $(this).data("processing", false);
            return;
        }

        $.ajax({
            url: 'https://script.google.com/macros/s/AKfycbxMx9GWeD6Ipl9PkUpbmIYQW3cxykounskMMTejcvo3lg6c12vUB3a4dwnaT2D6UeUejA/exec', // 배포된 GAS 웹앱 URL
            type: 'GET',
            dataType: 'json',
            data: { searchDate: searchDate, searchCode: searchCode },
            success: function(data) {
                $('#searchForm').data("processing", false);
                if (data.error) {
                    $('#result').html("<p style='color:red'>"+data.error+"</p>");
                    return;
                }
                var calculatedPeriod = calculatePeriod(searchDate);
                var tableHtml = `<table>
<tr><th colspan="2">개인별 정산서</th></tr>
<tr><td>기간</td><td>${calculatedPeriod}</td></tr>`;
                for (var key in data) {
                    if(key!=='기간') tableHtml += `<tr><td>${key}</td><td>${data[key]}</td></tr>`;
                }
                tableHtml += `</table>`;
                $('#result').html(tableHtml);
            },
            error: function() {
                $('#searchForm').data("processing", false);
                $('#result').html("<p style='color:red'>오류가 발생했습니다. 다시 시도해주세요.</p>");
            }
        });
    });
});
</script>
</body>
</html>
