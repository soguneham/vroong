<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>부릉라이더스 정산서 조회</title>
<link rel="icon" type="image/png" href="VRriders.png">
<style>
body { font-family: Arial; text-align: center; padding: 20px; }
table { max-width: 600px; width: 100%; border-collapse: collapse; margin: 20px auto; font-size: 16px; }
th, td { border: 1px solid black; padding: 10px; text-align: center; }
th { background-color: #b2dba1; }
td { background-color: #fff; }
.footer, .footer td { background-color: #b2dba1 !important; font-weight: bold; }
input { width: 95%; padding: 8px; font-size: 14px; }
button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
button:hover { background-color: #45a049; }
#result { margin-top: 20px; }
</style>
</head>
<body>
<h2>부릉라이더스 정산서 조회</h2>
<p>코드 및 정산 문의 : 010-9785-1293</p>

<form id="searchForm">
<table>
<tr><td>입금 날짜</td><td><input type="text" id="searchDate" name="searchDate" placeholder="예: 250307"></td></tr>
<tr><td>검색 코드</td><td><input type="text" id="searchCode" name="searchCode" placeholder="예: C202401001"></td></tr>
</table>
<button type="submit">검색</button>
</form>

<h3>검색 결과</h3>
<div id="result"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// 날짜 변환 yyMMdd → Date
function parseDate(searchDate) {
    var year = parseInt("20" + searchDate.substring(0,2));
    var month = parseInt(searchDate.substring(2,4)) - 1;
    var day = parseInt(searchDate.substring(4,6));
    return new Date(year, month, day);
}

// 기간 계산 (수요일~다음 화요일)
function calculatePeriod(searchDate) {
    var inputDate = parseDate(searchDate);
    var dayOfWeek = inputDate.getDay();
    var wednesdayDate = new Date(inputDate);
    wednesdayDate.setDate(inputDate.getDate() - ((dayOfWeek + 4) % 7));
    var tuesdayDate = new Date(wednesdayDate);
    tuesdayDate.setDate(wednesdayDate.getDate() + 6);
    function formatDate(date){ 
        var mm = String(date.getMonth()+1).padStart(2,'0'); 
        var dd = String(date.getDate()).padStart(2,'0'); 
        return mm+"/"+dd;
    }
    return formatDate(wednesdayDate) + " ~ " + formatDate(tuesdayDate);
}

$(document).ready(function(){
    $('#searchForm').submit(function(event){
        event.preventDefault();
        if ($(this).data("processing")) return;
        $(this).data("processing", true);

        var searchDate = $('#searchDate').val().trim();
        var searchCode = $('#searchCode').val().trim().toUpperCase();

        if (!/^\d{6}$/.test(searchDate)) { 
            alert("입금 날짜는 6자리 숫자로 입력하세요."); 
            $(this).data("processing", false); 
            return; 
        }
        if (!/^C\d{9}$/.test(searchCode)) { 
            alert("검색 코드는 'C'로 시작하는 10자리 형식이어야 합니다."); 
            $(this).data("processing", false); 
            return; 
        }

        $.ajax({
            url: 'https://script.google.com/macros/s/AKfycbzn_pbcijscbj1S2SnFw6r6a7BZWgVvjDOtFErt91OefrHoF5DO7spZRn2ChHmh8jQzvw/exec', // ← 여기에 배포 URL 입력
            type: 'GET',
            dataType: 'json',
            data: { searchDate: searchDate, searchCode: searchCode },
            success: function(data){
                $('#searchForm').data("processing", false);
                if(data.error){ 
                    $('#result').html("<p style='color:red'>"+data.error+"</p>"); 
                    return; 
                }

                var calculatedPeriod = calculatePeriod(searchDate);
                var tableHtml = `<table>
<tr><th colspan="2">개인별 정산서</th></tr>
<tr><td>기간</td><td>${calculatedPeriod}</td></tr>
<tr><td>코드</td><td>${data.코드}</td></tr>
<tr><td>총 오더 수</td><td>${data.총오더수}</td></tr>
<tr><td>수령금액</td><td>${data.수령금액}</td></tr>
<tr><td>과세 전 금액</td><td>${data.과세전금액}</td></tr>
<tr><td>고용보험</td><td>${data.고용보험}</td></tr>
<tr><td>산재보험</td><td>${data.산재보험}</td></tr>
<tr><td>시간제보험</td><td>${data.시간제보험}</td></tr>
<tr><td>보험료소급</td><td>${data.보험료소급}</td></tr>
<tr><td>프로모션</td><td>${data.프로모션}</td></tr>
<tr><td>소득세 (3.3%)</td><td>${data.소득세}</td></tr>
<tr class="footer"><td>실지급액</td><td>${data.실지급액}</td></tr>
<tr><td>1차 지급액 (화요일)</td><td>${data["1차지급액"]}</td></tr>
<tr><td>2차 지급액 (금요일)</td><td>${data["2차지급액"]}</td></tr>
<tr><td colspan="2">정산문의: ${data.정산문의}</td></tr>
</table>`;
                $('#result').html(tableHtml);
            },
            error: function(){ 
                $('#searchForm').data("processing", false); 
                $('#result').html("<p style='color:red'>오류가 발생했습니다.</p>"); 
            }
        });
    });
});
</script>
</body>
</html>
