<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부릉라이더스 정산서 조회</title>
    <link rel="icon" type="image/png" href="VRriders.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        table {
            max-width: 600px;
            width: 100%;
            border-collapse: collapse;
            margin: 20px auto;
            font-size: 16px;
        }
        th {
            background-color: #B2DBA1;
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        td {
            background-color: #FFFFFF;
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        .footer, .footer td {
            background-color: #B2DBA1 !important;
            font-weight: bold;
        }
        input {
            width: 95%;
            padding: 8px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45A049;
        }
        #result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>부릉라이더스 정산서 조회</h2>
    <p>코드 및 정산 문의 : 지점장</p>
    <form id="searchForm">
        <table>
            <tr>
                <td>입금 날짜</td>
                <td><input type="text" id="searchDate" name="searchDate" placeholder="예: 250307"></td>
            </tr>
            <tr>
                <td>검색 코드</td>
                <td><input type="text" id="searchCode" name="searchCode" placeholder="예: C202401001"></td>
            </tr>
        </table>
        <button type="submit">검색</button>
    </form>
    <h3>검색 결과</h3>
    <div id="result"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    // 입금일 기준 "전 주 수요일 ~ 해당 주 화요일" 범위 계산
    function calculatePeriod(searchDate) {
        var year = parseInt("20" + searchDate.substring(0, 2));
        var month = parseInt(searchDate.substring(2, 4)) - 1;
        var day = parseInt(searchDate.substring(4, 6));
        var inputDate = new Date(year, month, day);
        var dayOfWeek = inputDate.getDay(); // 0:일 ~ 6:토
        // "전 주" 수요일
        var wednesdayDate = new Date(inputDate);
        wednesdayDate.setDate(inputDate.getDate() - dayOfWeek - 4);
        // 해당 주 화요일 (수요일 + 6)
        var tuesdayDate = new Date(wednesdayDate);
        tuesdayDate.setDate(wednesdayDate.getDate() + 6);
        function formatDate(date) {
            var mm = String(date.getMonth() + 1).padStart(2, '0');
            var dd = String(date.getDate()).padStart(2, '0');
            return mm + "/" + dd;
        }
        return formatDate(wednesdayDate) + " ~ " + formatDate(tuesdayDate);
    }
    $(document).ready(function(){
        $('#searchForm').submit(function(event){
            event.preventDefault();
            if ($(this).data("processing")) return;
            $(this).data("processing", true);
            var searchDate = $('#searchDate').val().trim();
            var searchCode = $('#searchCode').val().trim().toUpperCase();
            // 유효성 검사
            if (!/^\d{6}$/.test(searchDate)) {
                alert("입금 날짜는 6자리 숫자로 입력하세요. (예: 250307)");
                $(this).data("processing", false);
                return;
            }
            if (!/^[Cc]\d{9}$/.test(searchCode)) {
                alert("검색 코드는 'C' 또는 'c'로 시작하는 10자리 형식이어야 합니다. (예: C202401001)");
                $(this).data("processing", false);
                return;
            }
            $.ajax({
                url: 'https://script.google.com/macros/s/AKfycbwS-d1_SyucL0OMD_GHRvdRq7OQLfuMU73194kEwYG4qW55aoDcB2GnLNB4Trbcuym8JQ/exec',
                type: 'GET',
                dataType: 'json',
                data: {
                    searchDate: searchDate,
                    searchCode: searchCode
                },
                success: function(data) {
                    $('#searchForm').data("processing", false);
                    if (data.error) {
                        $('#result').html("<p style='color:red'>" + data.error + "</p>");
                        return;
                    }
                    // 자동 계산된 정산주기
                    var calculatedPeriod = calculatePeriod(searchDate);
                    // 이미지 항목명으로 전체 교체된 결과 테이블
                    var tableHtml = `
                        <table>
                            <tr><th colspan="2">개인별 정산서</th></tr>
                            <tr><td>고유번호</td><td>${data.id}</td></tr>
                            <tr><td>라이더명</td><td>${data.name}</td></tr>
                            <tr><td>클러스터</td><td>${data.cluster}</td></tr>
                            <tr><td>구분</td><td>${data.type}</td></tr>
                            <tr><td>정산주기</td><td>${calculatedPeriod}</td></tr>
                            <tr><td>수행건수</td><td>${data.totalOrders}</td></tr>
                            <tr><td>정산서 정산금액 (A)</td><td>${data.settlementAmount}</td></tr>
                            <tr><td>관리자 달성액 (B)</td><td>${data.managerBonus}</td></tr>
                            <tr><td>프로모션 (C)</td><td>${data.promotion}</td></tr>
                            <tr><td>총과세금액 (D=A+B+C)</td><td>${data.taxableAmount}</td></tr>
                            <tr><td>기사부담 고용보험 ①</td><td>${data.employmentInsurance}</td></tr>
                            <tr><td>기사부담 산재보험 ②</td><td>${data.industrialInsurance}</td></tr>
                            <tr><td>시간제보험 ③</td><td>${data.hourlyInsurance}</td></tr>
                            <tr><td>보험료소급 ④</td><td>${data.insuranceBackpay}</td></tr>
                            <tr><td>소득세 (E=D*3%)</td><td>${data.tax}</td></tr>
                            <tr><td>지방소득세 (F=E*10%)</td><td>${data.localTax}</td></tr>
                            <tr><td>원천징수 (G=E+F)</td><td>${data.withholding}</td></tr>
                            <tr><td>1회차 정산금액</td><td>${data.firstSettlement}</td></tr>
                            <tr><td>선차감금액</td><td>${data.advanceDeductions}</td></tr>
                            <tr><td>1회차 지급예정액</td><td>${data.firstPlanned}</td></tr>
                            <tr><td>1회차 실지급액 (H)</td><td>${data.firstActual}</td></tr>
                            <tr><td>2회차 지급액 (I=J−H)</td><td>${data.secondPayment}</td></tr>
                            <tr class="footer"><td>총지급액 (J= D−①−②−③−④−G)</td><td>${data.totalPayment}</td></tr>
                            <tr><td>미정산금</td><td>${data.unpaid}</td></tr>
                        </table>
                    `;
                    $('#result').html(tableHtml);
                },
                error: function() {
                    $('#searchForm').data("processing", false);
                    $('#result').html("<p style='color:red'>오류가 발생했습니다. 다시 시도해주세요.</p>");
                }
            });
        });
    });
    </script>
</body>
</html>
